<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Daten eintragen</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

       <!-- Bootstrap -->
<!-- Latest compiled and minified CSS -->
 <link href="/static/css/bootstrap.min.css" rel="stylesheet">
        
        <link href="/static/css/custom.css" rel="stylesheet">

   <link href="/static/css/bootstrap-tagsinput.css" rel="stylesheet">
        
        
        <!-- Leaflet -->
         <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
   integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
   crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
   integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
   crossorigin=""></script>
        
          <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@2.1.1/dist/esri-leaflet.js"
    integrity="sha512-ECQqaYZke9cSdqlFG08zSkudgrdF6I1d8ViSa7I3VIszJyVqw4ng1G8sehEXlumdMnFYfzY0tMgdQa4WCs9IUw=="
    crossorigin=""></script>


  <!-- Load Esri Leaflet Geocoder from CDN -->
  <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.2.6/dist/esri-leaflet-geocoder.css"
    integrity="sha512-v5YmWLm8KqAAmg5808pETiccEohtt8rPVMGQ1jA6jqkWVydV5Cuz3nJ9fQ7ittSxvuqsvI9RSGfVoKPaAJZ/AQ=="
    crossorigin="">
  <script src="https://unpkg.com/esri-leaflet-geocoder@2.2.6/dist/esri-leaflet-geocoder-debug.js"
    integrity="sha512-NE6FicJEhXDHZNxWrGwC4gdaxb7iOMsp7+bQSintY+stx4GpoUpNAH+yuiE1uduT5inQCPPmH0lf0cdjJFfwcA=="
    crossorigin=""></script>
        

 <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
 <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
 <!--[if lt IE 9]>
 <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
 <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
 <![endif]-->
        
    </head>
    <body>
     

  
<div id="wrapper">
     <div id="mymap"></div>
     
 <div id="over_map">
       <button type="button" id="plusbutton" class="btn btn-default"><span class="glyphicon glyphicon-plus"></span></button>
   </div>
        
    <div id="over_map_points">
<button type="button" id="pointsbutton" class="btn btn-default">0 Punkte</button>
   </div>
    
  
    <div id="over_map_settings">
   <button type="button" id="settingsbutton" class="btn btn-default"><span class="glyphicon glyphicon-th-list"></span></button> 
    </div>
    
     <div class="dropdown over_map_user">
         
          <button type="button" id="userinfobutton" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-user"></span><span class="caret"></span></button>
  <ul class="dropdown-menu pull-right">
    <li><a href="/user/profile" id="myprofile">Mein Profil</a></li>
    <li><a href="/user/logout">Logout</a></li>
  </ul>
</div>
        
     <div class="modal fade" id="modal_profile">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
           <button type="button" class="close" data-dismiss="modal" aria-label="Close">
               <span aria-hidden="true">&times;</span>   </button>
        <h4 class="modal-title">Mein Profil</h4>
       
      </div>
      <div class="modal-body">
       <div class="row">
  <div class="col-xs-6">Meine Tags: X</div>
  <div class="col-xs-6">Meine Punkte: X</div>
</div>
          <br />
       Username: <%= user.username %>
    <br />
    E-Mail: <%= user.email %>
          <br />
      </div>
    </div>
  </div>
</div>
    
    
     <div class="modal fade" id="modal_settings">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
           <button type="button" class="close" data-dismiss="modal" aria-label="Close">
               <span aria-hidden="true">&times;</span>   </button>
        <h4 class="modal-title">Optionen</h4>
       
      </div>
      <div class="modal-body">
       <div class="row">
  
          <ul class="nav nav-pills nav-stacked">
 
 <li role="presentation"><a href="#modal_quests" data-toggle="modal" data-dismiss="modal">Quests</a></li>
  <li role="presentation"><a href="#modal_rank"data-toggle="modal" data-dismiss="modal">Rangliste</a></li>
  <li role="presentation"><a href="#modal_rounds" data-toggle="modal" data-dismiss="modal">Spielrunden</a></li>
</ul>
           
      </div>
    </div>
  </div>
</div>
    </div>
    
    
     <div class="modal fade" id="modal_rank">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
           <button type="button" class="close" data-dismiss="modal" aria-label="Close">
               <span aria-hidden="true">&times;</span>   </button>
        <h4 class="modal-title">Rangliste</h4>
       
      </div>
      <div class="modal-body">
    <div class="row">
    
        <br />
      <table class="table table-striped table-bordered">
  <thead>
    <tr>
      <th>Spieler</th>
      <th>Punkte</th>
      <th>Rang</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th scope="row">Mark</th>
      <td>12</td>
      <td>1</td>
    </tr>
    <tr>
      <th scope="row">Jacob</th>
      <td>9</td>
      <td>2</td>
    </tr>
    <tr>
      <th scope="row">Larry</th>
      <td>5</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
        
    </div>
    </div>
        <div class="modal-footer">
         <a href="#modal_settings" data-toggle="modal" data-dismiss="modal" class="btn btn-primary pull-left">Zurück zu Optionen</a>
      </div>
  </div>
</div>
    </div>
    
         <div class="modal fade" id="modal_rounds">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
           <button type="button" class="close" data-dismiss="modal" aria-label="Close">
               <span aria-hidden="true">&times;</span>   </button>
        <h4 class="modal-title">Optionen</h4>
       
      </div>
      <div class="modal-body">
       <div class="row">
  
          <h5>Aktuelle Runde:</h5>
   <a href="#" data-dismiss="modal"><button type="button" class="btn btn-primary btn-lg btn-block">Street-Art</button></a>
    <hr />

   <h5>Frühere Runden:</h5>

   <button type="button" class="btn btn-success btn-lg btn-block">Aufzüge</button>
    
    <hr />
   
   <button type="button" class="btn btn-warning btn-lg btn-block">Rolltreppen</button>
    
    <hr />
           
      </div>
    </div>
        <div class="modal-footer">
         <a href="#modal_settings" data-toggle="modal" data-dismiss="modal" class="btn btn-primary pull-left">Zurück zu Optionen</a>
      </div>
  </div>
</div>
    </div>
    
    
    <div class="modal fade" id="modal_marker">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
           <button type="button" class="close" data-dismiss="modal" aria-label="Close">
               <span aria-hidden="true">&times;</span>   </button>
        <h4 class="modal-title">Ein Tag</h4>
       
      </div>
      <div class="modal-body">
       <div class="row">
  
         <div id="marker_infos"></div>
           
      </div>
    </div>
       
  </div>
</div>
    </div>
    
       <div class="modal fade" id="modal_beitrag">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
           <button type="button" class="close" data-dismiss="modal" aria-label="Close">
               <span aria-hidden="true">&times;</span>   </button>
        <h4 class="modal-title">Neuen Beitrag anlegen</h4>
       
      </div>
      <div class="modal-body">
       <form id="beitrag_form">
    <div class="form-group">
         <label for="currentposition">Deine gewählte Position: </label>
        <div id="myposition"></div>
         <div id="myposition_geo"></div>
    </div>
 <div class="form-group">
 <label for="fileuploadlabel">Lade ein Bild von dem hoch, was du siehst:</label>
  <input type="file" class="form-control-file" id="fileupload">
 </div>
 <div class="form-group">
      <label for="categorylabel">Kategorisiere deinen Fund:</label>
     <br />
     <input type="text" id="tagsinput" value="" data-role="tagsinput"/>    
 
 </div>
     <div class="form-group">
    <label for="textarealabel">Hast du weitere Informationen?</label>
    <textarea class="form-control" id="textarea_infos" rows="3"></textarea>
  </div>
</form>
      </div>
      <div class="modal-footer">
         <button type="submit" id="beitrag_submit" class="btn btn-primary">Absenden</button>
      </div>
    </div>
  </div>
</div>
        </div>
       
       <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script>
           $( document ).ready(function() {
               
                 var latlng = {};
               
           
              
                $("#beitrag_submit").on('click', function (e) {
                        e.preventDefault();
                 
                        
                          var data = {

                            location: JSON.stringify(latlng),
                            categories: JSON.stringify([$('#tagsinput').val()]),
                              description: $('#textarea_infos').val(),
                              userID : "<%= user._id %>",
                              themeID : "<%= themeID %>"

                        }
                          
                       

                        $.ajax({
                            type: "POST",
                            url: "https://localhost:3000/objects/",
                            data: data,
                            success: function (response) {
                               newObject = response;
                                
                                console.log(response);
                                
                                $('#modal_beitrag').modal('hide')
                                
                              marker.setIcon(greenIcon).dragging.disable(); 
                                
                            }
                            ,
                            error: function (err) {
                                console.log(err);
                            }
                        });

                });

               var mymap = L.map('mymap');

	L.tileLayer( 'https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
        maxZoom: 18, attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors' }).addTo( mymap );



	function onLocationError(e) {
		alert(e.message);
	}


	mymap.on('locationerror', onLocationError);

	mymap.locate({setView: true, maxZoom: 16});

       
        var geocodeService = L.esri.Geocoding.geocodeService();

       var marker = null;
       
 	function onLocationFound(e) {
       
		
        marker = L.marker(e.latlng, {
draggable: true
}).addTo(mymap).on('dragend', onDragEnd);
        
        
        var radius = e.accuracy / 2;
        
        latlng = e.latlng;
        
 geocodeService.reverse().latlng(e.latlng).run(function(error, result) {
      marker.bindPopup(result.address.Match_addr).openPopup();      

		//L.circle(e.latlng, radius).addTo(mymap);
     
       $('#myposition').html(result.address.Match_addr);
    
     
          });
        
      
        
    }
               
               
               mymap.on('locationfound', onLocationFound);
        
               
                   $.ajax({
                            type: "GET",
                            url: "https://localhost:3000/objects/",
                            success: function (response) {
                               
                                //console.log(response);
                             
                                var markers = [];
                                
                               jQuery.map( response, function( val, i ) {
                                   
                        
                           
                                 
         markers[i] = L.marker(JSON.parse(val.location) , {icon: greenIcon
}).addTo(mymap);
                             
                                   
                                    markers[i].on('click', function() {
                                        
                                         geocodeService.reverse().latlng(JSON.parse(val.location)).run(function(error, result) {
      markers[i].bindPopup(result.address.Match_addr).openPopup();      

     
	  $('#myposition').html(result.address.Match_addr);
         
    
  });
                                        
                         $("#marker_infos").html("Erstellt: "+val.createdAt +"<br>"+ "Zuletzt aktualisiert: "+val.updatedAt+"<br>"+"Kategorien: "+val.categories+"<br>"+"Beschreibung: "+val.description);
                                        
                                        
                                        
                                        
          $("#modal_marker").modal("show"); 
        });
             
           
                               });
                                                            
                                
                            }
                            ,
                            error: function (err) {
                                console.log(err);
                            }
                        });
                   
                 
              
               
       
               function onDragEnd(event) 
{
  
     var radius = event.target.accurancy / 2;
    var marker = event.target;
    var position = marker.getLatLng();
    marker.setLatLng(new L.LatLng(position.lat, position.lng),{draggable:'true'});
    mymap.panTo(new L.LatLng(position.lat, position.lng))
    
    geocodeService.reverse().latlng(position).run(function(error, result) {
      marker.bindPopup(result.address.Match_addr).openPopup();      

        latlng = position;
	  $('#myposition').html(result.address.Match_addr);
         
    
  });
  mymap.addLayer(marker);
}
        

//mymap.on('click', onMapClick);
               
                //getting click event to show modal
    $('#plusbutton').click(function () {
        $('#modal_beitrag').modal();
      
      //appending modal background inside the bigform-content
        $('.modal-backdrop').appendTo('#wrapper');
      //removing body classes to able click events
        $('body').removeClass();
    });
               
               
                 //getting click event to show modal
    $('#settingsbutton').click(function () {
        $('#modal_settings').modal();
      
      //appending modal background inside the bigform-content
        $('.modal-backdrop').appendTo('#wrapper');
      //removing body classes to able click events
        $('body').removeClass();
    });
               
                     //getting click event to show modal
    $('#myprofile').click(function (e) {
        e.preventDefault();
        $('#modal_profile').modal();
      
      //appending modal background inside the bigform-content
        $('.modal-backdrop').appendTo('#wrapper');
      //removing body classes to able click events
        $('body').removeClass();
    });
               
               
               var citynames = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  prefetch: {
    url: '/static/citynames.json',
    filter: function(list) {
      return $.map(list, function(cityname) {
        return { name: cityname }; });
    }
  }
});
citynames.initialize();

$('#tagsinput').tagsinput({
  typeaheadjs: {
    name: 'citynames',
    displayKey: 'name',
    valueKey: 'name',
    source: citynames.ttAdapter()
  },   confirmKeys: [44,188,32]
});
               
       });</script>
        
        
        
 <!-- Include all compiled plugins (below), or include individual files as needed -->
<!-- Latest compiled and minified JavaScript -->
   <script src="/static/js/bootstrap.min.js"></script>
      
         <script src="/static/js/bootstrap-tagsinput.js"></script>
        
         <script src="/static/js/typeahead.js"></script>
        
        <script src="/static/js/leaflet-color-markers.js"></script>
    </body>
</html>
